<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <link rel="stylesheet" type="text/css" href="font_Icon/iconfont.css">
    <link rel="stylesheet" type="text/css" href="css/chat.css">

</head>
<body>

<div class="chatContainer">
    <div class="chatBtn">
        <i class="iconfont icon-xiaoxi1"></i>
        <span class="notify-num" id="notify-num"></span>
    </div>
    <div class="chat-message-num"></div>
    <div class="chatBox" ref="chatBox">
        <div class="chatBox-head">
            <div class="chatBox-head-one">
                陈萍萍
                <div class="chat-close" style="margin: 10px 10px 0 0;font-size: 14px">关闭</div>
            </div>
            <div class="chatBox-head-two">
                <div class="chat-return">返回</div>
                <div class="chat-people">
                    <div class="ChatInfoHead">
                        <img src="" alt="头像"/>
                    </div>
                    <div class="ChatInfoName">这是用户的名字，看看名字到底能有多长</div>
                </div>

            </div>
        </div>
        <div class="chatBox-info">
            <div class="chatBox-list" ref="chatBoxlist">
                <div class="chat-notify">
                    <div><img src="img/icon01.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>通知信息</p>
                    </div>
                    <div class="notify-num"></div>
                </div>

                <div class="chat-list-people">
                    <div><img src="img/icon01.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>公共频道</p>
                    </div>

                </div>


            </div>

            <div class="chatBox-kuang" ref="chatBoxkuang">
                <div class="chatBox-content">
                    <div class="chatBox-content-demo" id="chatBox-content-demo">

                    </div>
                </div>
                <div class="chatBox-send">
                    <div class="div-textarea" contenteditable="true"></div>
                    <div>
                        <button id="chat-fasong" class="btn-default-styles"><i class="iconfont icon-fasong"></i>
                        </button>
                    </div>

                </div>
            </div>

            <div class="chatBox-kuang-notify" ref="chatBoxkuang">
                <div class="chatBox-content">
                    <div class="chatBox-content-demo-notify" id="chatBox-content-demo-notify">

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


<script src="/js/jquery.min.js"></script>
<script>
    var firstIntoNotifyDiv = true;
    var curRequestPath = window.document.location.href;
    var urlAndPath = curRequestPath.substring(7); // 截掉http://
    var url = urlAndPath.substring(0, urlAndPath.indexOf(":"));
    var groupId = $("#groupId", window.parent.document).val();
    var userId = $("#userId", window.parent.document).val();
    var userName = $("#userName", window.parent.document).val();

    window.CHAT = {
        socket: null,
        init: function () {
            if (window.WebSocket) {
                // ws://机器地址:netty绑定的端口/服务端定义socket路径
                CHAT.socket = new WebSocket("ws://" + url + ":8090/ws");
                CHAT.socket.onopen = function () {
                    console.log(userId);
                    //向netty注册自己的信息
                    var json = '{"type":"login","userId":"' + userId + '","baseInfo":"' + groupId + '#' + userName + '#钢铁公司#川师大"}';
                    CHAT.socket.send(json);
                }, CHAT.socket.onclose = function () {
                    console.log("连接关闭");
                }, CHAT.socket.onerror = function () {
                    console.log("异常");
                }, CHAT.socket.onmessage = function (e) {
                    var data = e.data;
                    var jsonObj = jQuery.parseJSON(data);
                    if (jsonObj.type == "login") {
                        console.log("连接成功");
                    } else if (jsonObj.type == "sendGroup") {
                        // groupId#姓名#公司名#学校名#formatTime#value
                        var msg = jsonObj.value;
                        var msgs = msg.split("#");
                        if (jsonObj.from == userId) {
                            appendPublicMsgMine(msgs[4], msgs[5]);
                            //发送后清空输入框
                            $(".div-textarea").html("");
                        } else {
                            appendPublicMsgOther(msgs[1], msgs[4], msgs[5]);
                        }
                        //聊天框自动滑动到最下方
                        var box = document.getElementById('chatBox-content-demo');
                        box.scrollTop = box.scrollHeight;

                        //判断通知信息
                        if (jsonObj.notify) {
                            //拼接通知信息
                            appendNotifyMsgOther(msgs[1], msgs[4], msgs[5]);
                            var notifynum = $("#notify-num").text();
                            if (notifynum) {
                                notifynum = parseInt(notifynum) + 1;
                            } else {
                                notifynum = 1;
                            }
                            $(".notify-num").each(function () {
                                $(this).text(notifynum);
                                $(this).show();
                            })
                        }
                    } else if (jsonObj.type == "hisNotify") {
                        //拼接历史通知
                        let notifys = jsonObj.value;
                        for (let i = notifys.length - 1; i >= 0; i = i - 1) {
                            let msg = notifys[i];
                            let msgs = msg.split("#");
                            appendNotifyMsgOther(msgs[1], msgs[4], msgs[5]);
                        }
                    }
                }
            } else {
                alert("浏览器不支持websocket协议，换个浏览器试试吧");
            }
        },

        clean: function () {
            $("#content").html("")
        }
    }
    CHAT.init();

    //公共聊天框拼接他人信息
    function appendPublicMsgOther(name, time, msg) {
        let newTime = formatTime(time);
        $(".chatBox-content-demo").append("" +
            "<div class=\"clearfloat\">" +
            "   <div class=\"author-name\">" + name +
            "       <small class=\"chat-date\">" + newTime + "</small> " +
            "   </div> " +
            "   <div class=\"left\"> " +
            "       <div class=\"chat-avatars\">" +
            "           <img src=\"img/icon01.png\" alt=\"头像\" />" +
            "       </div> " +
            "       <div class=\"chat-message\"> " + msg + " </div> " +
            "   </div> " +
            "</div>");
    }

    //格式化时间格式为 yyyy/MM/dd hh:mm:ss
    function formatTime(yyyyMMddHHmmss) {
        let year = yyyyMMddHHmmss.substring(0, 4);
        let month = yyyyMMddHHmmss.substring(4, 6);
        let day = yyyyMMddHHmmss.substring(6, 8);
        let hour = yyyyMMddHHmmss.substring(8, 10);
        let minu = yyyyMMddHHmmss.substring(10, 12);
        let sec = yyyyMMddHHmmss.substring(12, 14);
        let time = year + "/" + month + "/" + day + " " + hour + ":" + minu + ":" + sec;
        return time;
    }

    //公共聊天框拼接我的信息
    function appendPublicMsgMine(time, msg) {
        let newTime = formatTime(time);
        $(".chatBox-content-demo").append("" +
            "<div class=\"clearfloat\">" +
            "   <div class=\"author-name\">" +
            "       <small class=\"chat-date\">" + newTime + "</small> " +
            "   </div> " +
            "   <div class=\"right\"> " +
            "       <div class=\"chat-message\"> " + msg + " </div> " +
            "       <div class=\"chat-avatars\">" +
            "           <img src=\"img/icon01.png\" alt=\"头像\" />" +
            "       </div> " +
            "   </div> " +
            "</div>");

    }

    //通知框拼接消息
    function appendNotifyMsgOther(name, time, msg) {
        let newTime = formatTime(time);
        $(".chatBox-content-demo-notify").append("" +
            "<div class=\"clearfloat\">" +
            "   <div class=\"author-name\">" + name +
            "       <small class=\"chat-date\">" + newTime + "</small> " +
            "   </div> " +
            "   <div class=\"left\"> " +
            "       <div class=\"chat-avatars\">" +
            "           <img src=\"img/icon01.png\" alt=\"头像\" />" +
            "       </div> " +
            "       <div class=\"chat-message\"> " + msg + " </div> " +
            "   </div> " +
            "</div>");
        //聊天框自动滑动到最下方
        var box = document.getElementById('chatBox-content-demo-notify');
        box.scrollTop = box.scrollHeight;
    }


    screenFuc();

    function screenFuc() {
        var topHeight = $(".chatBox-head").innerHeight();//聊天头部高度
        //屏幕小于768px时候,布局change
        var winWidth = $(window).innerWidth();
        if (winWidth <= 768) {
            var totalHeight = $(window).height(); //页面整体高度
            $(".chatBox-info").css("height", totalHeight - topHeight);
            var infoHeight = $(".chatBox-info").innerHeight();//聊天头部以下高度
            //中间内容高度
            $(".chatBox-content").css("height", infoHeight - 46);
            $(".chatBox-content-demo").css("height", infoHeight - 46);

            $(".chatBox-list").css("height", totalHeight - topHeight);
            $(".chatBox-kuang").css("height", totalHeight - topHeight);
            $(".div-textarea").css("width", winWidth - 106);
        } else {
            $(".chatBox-info").css("height", 495);
            $(".chatBox-content").css("height", 448);
            $(".chatBox-content-demo").css("height", 448);
            $(".chatBox-list").css("height", 495);
            $(".chatBox-kuang").css("height", 495);
            $(".div-textarea").css("width", 260);
        }
    }

    (window.onresize = function () {
        screenFuc();
    })();
    //未读信息数量为空时
    var totalNum = $(".chat-message-num").html();
    if (totalNum == "") {
        $(".chat-message-num").css("padding", 0);
    }
    $(".message-num").each(function () {
        var wdNum = $(this).html();
        if (wdNum == "") {
            $(this).css("padding", 0);
        }
    });


    //打开/关闭聊天框
    $(".chatBtn").click(function () {
        $(".chatBox").toggle(10);
    })
    $(".chat-close").click(function () {
        $(".chatBox").toggle(10);
    })

    //进聊天页面
    $(".chat-list-people").each(function () {
        $(this).click(function () {
            var n = $(this).index();
            $(".chatBox-head-one").fadeOut();
            $(".chatBox-head-two").fadeIn();
            $(".chatBox-list").fadeOut();
            $(".chatBox-kuang").fadeIn();

            //传名字
            $(".ChatInfoName").text($(this).children(".chat-name").children("p").eq(0).html());

            //传头像
            $(".ChatInfoHead>img").attr("src", $(this).children().eq(0).children("img").attr("src"));

            //聊天框默认最底部
            $(document).ready(function () {
                $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
            });
        })
    });


    //进通知页面
    $(".chat-notify").each(function () {
        $(this).click(function () {
            var n = $(this).index();
            $(".chatBox-head-one").fadeOut();
            $(".chatBox-head-two").fadeIn();
            $(".chatBox-list").fadeOut();
            $(".chatBox-kuang").fadeOut();
            $(".chatBox-kuang-notify").fadeIn();
            $(".notify-num").each(function () {
                $(this).text("");
                $(this).hide();
            })

            //传名字
            $(".ChatInfoName").text($(this).children(".chat-name").children("p").eq(0).html());

            //传头像
            $(".ChatInfoHead>img").attr("src", $(this).children().eq(0).children("img").attr("src"));

            //聊天框默认最底部
            $(document).ready(function () {
                $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
            });
            //第一次进入通知栏目
            if (firstIntoNotifyDiv) {
                queryNotifyHistory();
                firstIntoNotifyDiv = false;
            }
        })
    });

    //第一次进入，查询历史通知
    function queryNotifyHistory() {
        var json = '{"type":"hisNotify","userId":"' + userId + '","groupId":"' + groupId + '"}';
        CHAT.socket.send(json);
    }

    //返回列表
    $(".chat-return").click(function () {
        $(".chatBox-head-one").fadeIn(1);
        $(".chatBox-head-two").fadeOut(1);
        $(".chatBox-list").fadeIn(1);
        $(".chatBox-kuang").fadeOut(1);
        $(".chatBox-kuang-notify").fadeOut(1);
    });

    //发送信息
    $("#chat-fasong").click(function () {
        var textContent = $(".div-textarea").html().replace(/[\n\r]/g, '<br>')
        if (textContent != "") {
            var json = '{"type":"sendGroup","value":"' + textContent + '"}';
            CHAT.socket.send(json);

        }
    });

    //发送表情
    $("#chat-biaoqing").click(function () {
        $(".biaoqing-photo").toggle();
    });
    $(document).click(function () {
        $(".biaoqing-photo").css("display", "none");
    });
    $("#chat-biaoqing").click(function (event) {
        event.stopPropagation();//阻止事件
    });

    $(".emoji-picker-image").each(function () {
        $(this).click(function () {
            var bq = $(this).parent().html();
            console.log(bq)
            $(".chatBox-content-demo").append("<div class=\"clearfloat\">" +
                "<div class=\"author-name\"><small class=\"chat-date\">2017-12-02 14:26:58</small> </div> " +
                "<div class=\"right\"> <div class=\"chat-message\"> " + bq + " </div> " +
                "<div class=\"chat-avatars\"><img src=\"img/icon01.png\" alt=\"头像\" /></div> </div> </div>");
            //发送后关闭表情框
            $(".biaoqing-photo").toggle();
            //聊天框默认最底部
            $(document).ready(function () {
                $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
            });
        })
    });

    // //      发送图片
    // function selectImg(pic) {
    //     if (!pic.files || !pic.files[0]) {
    //         return;
    //     }
    //     var reader = new FileReader();
    //     reader.onload = function (evt) {
    //         var images = evt.target.result;
    //         $(".chatBox-content-demo").append("<div class=\"clearfloat\">" +
    //             "<div class=\"author-name\"><small class=\"chat-date\">2017-12-02 14:26:58</small> </div> " +
    //             "<div class=\"right\"> <div class=\"chat-message\"><img src=" + images + "></div> " +
    //             "<div class=\"chat-avatars\"><img src=\"img/icon01.png\" alt=\"头像\" /></div> </div> </div>");
    //         //聊天框默认最底部
    //         $(document).ready(function () {
    //             $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
    //         });
    //     };
    //     reader.readAsDataURL(pic.files[0]);
    //
    // }


</script>

</body>
</html>
